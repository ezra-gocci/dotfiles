---
# ─── macOS System Defaults ────────────────────────────────
#
# Uses community.general.osx_defaults for declarative config.
# All settings match macos/defaults.sh (the bash fallback).

# Close System Preferences to prevent overriding
- name: Close System Settings
  ansible.builtin.shell: osascript -e 'tell application "System Settings" to quit' 2>/dev/null || true
  changed_when: false

# ═══ General UI/UX ════════════════════════════════════════

- name: Disable boot sound
  ansible.builtin.shell: sudo nvram SystemAudioVolume=" "
  become: true
  changed_when: true

- name: Save to disk by default (not iCloud)
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSDocumentSaveNewDocumentsToCloud
    type: bool
    value: false

- name: Disable automatic capitalization
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSAutomaticCapitalizationEnabled
    type: bool
    value: false

- name: Disable smart dashes
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSAutomaticDashSubstitutionEnabled
    type: bool
    value: false

- name: Disable automatic period substitution
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSAutomaticPeriodSubstitutionEnabled
    type: bool
    value: false

- name: Disable smart quotes
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSAutomaticQuoteSubstitutionEnabled
    type: bool
    value: false

- name: Disable auto-correct
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSAutomaticSpellingCorrectionEnabled
    type: bool
    value: false

# ═══ Trackpad & Keyboard ═════════════════════════════════

- name: Enable tap to click (trackpad)
  community.general.osx_defaults:
    domain: com.apple.driver.AppleBluetoothMultitouch.trackpad
    key: Clicking
    type: bool
    value: true

- name: Enable tap to click (login screen)
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: com.apple.mouse.tapBehavior
    type: int
    value: 1

- name: Set fast keyboard repeat rate
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: KeyRepeat
    type: int
    value: 2

- name: Set short initial key repeat delay
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: InitialKeyRepeat
    type: int
    value: 15

- name: Enable full keyboard access for all controls
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleKeyboardUIMode
    type: int
    value: 3

- name: Disable press-and-hold for accent characters
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: ApplePressAndHoldEnabled
    type: bool
    value: false

# ═══ Finder ══════════════════════════════════════════════

- name: Show hidden files in Finder
  community.general.osx_defaults:
    domain: com.apple.finder
    key: AppleShowAllFiles
    type: bool
    value: true

- name: Show all filename extensions
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleShowAllExtensions
    type: bool
    value: true

- name: Show Finder status bar
  community.general.osx_defaults:
    domain: com.apple.finder
    key: ShowStatusBar
    type: bool
    value: true

- name: Show Finder path bar
  community.general.osx_defaults:
    domain: com.apple.finder
    key: ShowPathbar
    type: bool
    value: true

- name: Keep folders on top when sorting
  community.general.osx_defaults:
    domain: com.apple.finder
    key: _FXSortFoldersFirst
    type: bool
    value: true

- name: Search current folder by default
  community.general.osx_defaults:
    domain: com.apple.finder
    key: FXDefaultSearchScope
    type: string
    value: "SCcf"

- name: Disable file extension change warning
  community.general.osx_defaults:
    domain: com.apple.finder
    key: FXEnableExtensionChangeWarning
    type: bool
    value: false

- name: Avoid .DS_Store on network volumes
  community.general.osx_defaults:
    domain: com.apple.desktopservices
    key: DSDontWriteNetworkStores
    type: bool
    value: true

- name: Avoid .DS_Store on USB volumes
  community.general.osx_defaults:
    domain: com.apple.desktopservices
    key: DSDontWriteUSBStores
    type: bool
    value: true

- name: Use list view in Finder by default
  community.general.osx_defaults:
    domain: com.apple.finder
    key: FXPreferredViewStyle
    type: string
    value: "Nlsv"

- name: Show ~/Library folder
  ansible.builtin.shell: chflags nohidden ~/Library
  changed_when: true

- name: Show /Volumes folder
  ansible.builtin.shell: chflags nohidden /Volumes
  become: true
  changed_when: true

# ═══ Dock ════════════════════════════════════════════════

- name: Set Dock icon size
  community.general.osx_defaults:
    domain: com.apple.dock
    key: tilesize
    type: int
    value: "{{ dock_tilesize }}"

- name: Disable Dock auto-rearrange Spaces
  community.general.osx_defaults:
    domain: com.apple.dock
    key: mru-spaces
    type: bool
    value: false

- name: Set Dock auto-hide delay
  community.general.osx_defaults:
    domain: com.apple.dock
    key: autohide-delay
    type: float
    value: "{{ dock_autohide_delay }}"

- name: Set Dock hide/show animation speed
  community.general.osx_defaults:
    domain: com.apple.dock
    key: autohide-time-modifier
    type: float
    value: "{{ dock_autohide_time_modifier }}"

- name: Enable Dock auto-hide
  community.general.osx_defaults:
    domain: com.apple.dock
    key: autohide
    type: bool
    value: "{{ dock_autohide }}"

- name: Hide recent applications in Dock
  community.general.osx_defaults:
    domain: com.apple.dock
    key: show-recents
    type: bool
    value: "{{ dock_show_recents }}"

# ═══ Safari & WebKit ═════════════════════════════════════

- name: "Safari: disable search suggestions to Apple"
  community.general.osx_defaults:
    domain: com.apple.Safari
    key: UniversalSearchEnabled
    type: bool
    value: false

- name: "Safari: suppress search suggestions"
  community.general.osx_defaults:
    domain: com.apple.Safari
    key: SuppressSearchSuggestions
    type: bool
    value: true

- name: "Safari: show full URL"
  community.general.osx_defaults:
    domain: com.apple.Safari
    key: ShowFullURLInSmartSearchField
    type: bool
    value: true

- name: "Safari: enable Develop menu"
  community.general.osx_defaults:
    domain: com.apple.Safari
    key: IncludeDevelopMenu
    type: bool
    value: true

- name: "Safari: enable Web Inspector"
  community.general.osx_defaults:
    domain: com.apple.Safari
    key: WebKitDeveloperExtrasEnabledPreferenceKey
    type: bool
    value: true

# ═══ Terminal ════════════════════════════════════════════

- name: Use UTF-8 only in Terminal.app
  community.general.osx_defaults:
    domain: com.apple.terminal
    key: StringEncodings
    type: array
    value:
      - 4

# ═══ Time Machine ════════════════════════════════════════

- name: Disable Time Machine new disk prompts
  community.general.osx_defaults:
    domain: com.apple.TimeMachine
    key: DoNotOfferNewDisksForBackup
    type: bool
    value: true

# ═══ Activity Monitor ════════════════════════════════════

- name: Show main window on launch
  community.general.osx_defaults:
    domain: com.apple.ActivityMonitor
    key: OpenMainWindow
    type: bool
    value: true

- name: Show CPU usage in Dock icon
  community.general.osx_defaults:
    domain: com.apple.ActivityMonitor
    key: IconType
    type: int
    value: 5

- name: Show all processes
  community.general.osx_defaults:
    domain: com.apple.ActivityMonitor
    key: ShowCategory
    type: int
    value: 0

# ═══ TextEdit ════════════════════════════════════════════

- name: Use plain text mode by default
  community.general.osx_defaults:
    domain: com.apple.TextEdit
    key: RichText
    type: int
    value: 0

- name: Open files as UTF-8
  community.general.osx_defaults:
    domain: com.apple.TextEdit
    key: PlainTextEncoding
    type: int
    value: 4

- name: Save files as UTF-8
  community.general.osx_defaults:
    domain: com.apple.TextEdit
    key: PlainTextEncodingForWrite
    type: int
    value: 4

# ═══ Screenshots ═════════════════════════════════════════

- name: Save screenshots to Desktop
  community.general.osx_defaults:
    domain: com.apple.screencapture
    key: location
    type: string
    value: "{{ ansible_env.HOME }}/Desktop"

- name: Save screenshots as PNG
  community.general.osx_defaults:
    domain: com.apple.screencapture
    key: type
    type: string
    value: "png"

- name: Disable screenshot shadow
  community.general.osx_defaults:
    domain: com.apple.screencapture
    key: disable-shadow
    type: bool
    value: true

# ═══ Hot Corners ═════════════════════════════════════════

- name: "Hot corner: top-left"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-tl-corner
    type: int
    value: "{{ hot_corner_top_left }}"

- name: "Hot corner: top-left modifier"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-tl-modifier
    type: int
    value: 0

- name: "Hot corner: top-right"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-tr-corner
    type: int
    value: "{{ hot_corner_top_right }}"

- name: "Hot corner: top-right modifier"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-tr-modifier
    type: int
    value: 0

- name: "Hot corner: bottom-left"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-bl-corner
    type: int
    value: "{{ hot_corner_bottom_left }}"

- name: "Hot corner: bottom-left modifier"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-bl-modifier
    type: int
    value: 0

- name: "Hot corner: bottom-right"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-br-corner
    type: int
    value: "{{ hot_corner_bottom_right }}"

- name: "Hot corner: bottom-right modifier"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-br-modifier
    type: int
    value: 0

# ═══ Energy & Display ════════════════════════════════════

- name: "Battery: display sleep after {{ energy_battery_display_sleep }} min"
  ansible.builtin.shell: "pmset -b displaysleep {{ energy_battery_display_sleep }}"
  become: true
  changed_when: true

- name: "Charger: display sleep after {{ energy_charger_display_sleep }} min"
  ansible.builtin.shell: "pmset -c displaysleep {{ energy_charger_display_sleep }}"
  become: true
  changed_when: true

- name: "Charger: system sleep {{ 'disabled' if energy_charger_system_sleep == 0 else (energy_charger_system_sleep | string + ' min') }}"
  ansible.builtin.shell: "pmset -c sleep {{ energy_charger_system_sleep }}"
  become: true
  changed_when: true

# ═══ Hostname ════════════════════════════════════════════

- name: Set ComputerName
  ansible.builtin.shell: "scutil --set ComputerName '{{ hostname }}'"
  become: true
  changed_when: true

- name: Set HostName
  ansible.builtin.shell: "scutil --set HostName '{{ hostname }}'"
  become: true
  changed_when: true

- name: Set LocalHostName
  ansible.builtin.shell: "scutil --set LocalHostName '{{ hostname }}'"
  become: true
  changed_when: true

- name: Set NetBIOS name
  community.general.osx_defaults:
    domain: /Library/Preferences/SystemConfiguration/com.apple.smb.server
    key: NetBIOSName
    type: string
    value: "{{ hostname }}"
  become: true

# ═══ Restart Affected Applications ═══════════════════════

- name: Restart Dock, Finder, and SystemUIServer
  ansible.builtin.shell: |
    killall Dock 2>/dev/null || true
    killall Finder 2>/dev/null || true
    killall SystemUIServer 2>/dev/null || true
  changed_when: true
