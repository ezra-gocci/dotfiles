---
# ─── macOS System Defaults ────────────────────────────────
#
# Uses community.general.osx_defaults for declarative config.
# All settings match macos/defaults.sh (the bash fallback).

# Close System Preferences to prevent overriding
- name: Close System Settings
  ansible.builtin.shell: osascript -e 'tell application "System Settings" to quit' 2>/dev/null || true
  changed_when: false

# ═══ General UI/UX ════════════════════════════════════════

- name: Disable boot sound
  ansible.builtin.shell: sudo nvram SystemAudioVolume=" "
  become: true
  changed_when: true

- name: Save to disk by default (not iCloud)
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSDocumentSaveNewDocumentsToCloud
    type: bool
    value: false

- name: Disable automatic capitalization
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSAutomaticCapitalizationEnabled
    type: bool
    value: false

- name: Disable smart dashes
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSAutomaticDashSubstitutionEnabled
    type: bool
    value: false

- name: Disable automatic period substitution
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSAutomaticPeriodSubstitutionEnabled
    type: bool
    value: false

- name: Disable smart quotes
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSAutomaticQuoteSubstitutionEnabled
    type: bool
    value: false

- name: Disable auto-correct
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSAutomaticSpellingCorrectionEnabled
    type: bool
    value: false

# ═══ Appearance ════════════════════════════════════════════

- name: Set appearance to Auto (light/dark)
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleInterfaceStyleSwitchesAutomatically
    type: bool
    value: true

- name: Set sidebar icon size to Small
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSTableViewDefaultSizeMode
    type: int
    value: 1

- name: "Scroll bar: jump to spot clicked"
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleScrollerPagingBehavior
    type: int
    value: 1

# ═══ Trackpad & Keyboard ═════════════════════════════════

- name: Enable tap to click (trackpad)
  community.general.osx_defaults:
    domain: com.apple.driver.AppleBluetoothMultitouch.trackpad
    key: Clicking
    type: bool
    value: true

- name: Enable tap to click (internal trackpad)
  community.general.osx_defaults:
    domain: com.apple.AppleMultitouchTrackpad
    key: Clicking
    type: bool
    value: true

- name: Enable tap to click (login screen)
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: com.apple.mouse.tapBehavior
    type: int
    value: 1

- name: "Trackpad: set firm click threshold"
  community.general.osx_defaults:
    domain: com.apple.AppleMultitouchTrackpad
    key: FirstClickThreshold
    type: int
    value: 2

- name: "Trackpad: set firm secondary click threshold"
  community.general.osx_defaults:
    domain: com.apple.AppleMultitouchTrackpad
    key: SecondClickThreshold
    type: int
    value: 2

- name: "Trackpad: enable three-finger drag"
  community.general.osx_defaults:
    domain: com.apple.AppleMultitouchTrackpad
    key: TrackpadThreeFingerDrag
    type: bool
    value: true

- name: "Trackpad: enable three-finger drag (bluetooth)"
  community.general.osx_defaults:
    domain: com.apple.driver.AppleBluetoothMultitouch.trackpad
    key: TrackpadThreeFingerDrag
    type: bool
    value: true

- name: "Trackpad: set tracking speed"
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: com.apple.trackpad.scaling
    type: float
    value: 1.5

- name: Enable spring-loading
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: com.apple.springing.enabled
    type: bool
    value: true

- name: Set fast keyboard repeat rate
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: KeyRepeat
    type: int
    value: 2

- name: Set short initial key repeat delay
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: InitialKeyRepeat
    type: int
    value: 15

- name: Enable full keyboard access for all controls
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleKeyboardUIMode
    type: int
    value: 3

- name: Disable press-and-hold for accent characters
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: ApplePressAndHoldEnabled
    type: bool
    value: false

- name: "Globe key: Change Input Source"
  community.general.osx_defaults:
    domain: com.apple.HIToolbox
    key: AppleFnUsageType
    type: int
    value: 1

# ═══ Input Sources ═════════════════════════════════════════

- name: Configure keyboard input sources (ABC, Russian-PC, Armenian-HM QWERTY)
  ansible.builtin.shell: |
    defaults write com.apple.HIToolbox AppleEnabledInputSources -array \
      '{ InputSourceKind = "Keyboard Layout"; "KeyboardLayout ID" = 252; "KeyboardLayout Name" = ABC; }' \
      '{ InputSourceKind = "Keyboard Layout"; "KeyboardLayout ID" = 19458; "KeyboardLayout Name" = RussianWin; }' \
      '{ InputSourceKind = "Keyboard Layout"; "KeyboardLayout ID" = -28161; "KeyboardLayout Name" = "Armenian-HM QWERTY"; }' \
      '{ "Bundle ID" = "com.apple.CharacterPaletteIM"; InputSourceKind = "Non Keyboard Input Method"; }' \
      '{ "Bundle ID" = "com.apple.inputmethod.EmojiFunctionRowItem"; InputSourceKind = "Non Keyboard Input Method"; }'
  changed_when: true

# ═══ Language & Region ═════════════════════════════════════

- name: Set preferred languages
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleLanguages
    type: array
    value: "{{ apple_languages }}"

- name: Set locale
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleLocale
    type: string
    value: "{{ apple_locale }}"

- name: Set measurement units to Metric
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleMeasurementUnits
    type: string
    value: Centimeters

- name: Enable metric system
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleMetricSystem
    type: bool
    value: true

- name: Set temperature to Celsius
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleTemperatureUnit
    type: string
    value: Celsius

- name: "Set date format (y/M/d)"
  ansible.builtin.shell: |
    defaults write NSGlobalDomain AppleICUDateFormatStrings -dict 1 "{{ apple_date_format }}"
  changed_when: true

# ═══ Finder ══════════════════════════════════════════════

- name: Show hidden files in Finder
  community.general.osx_defaults:
    domain: com.apple.finder
    key: AppleShowAllFiles
    type: bool
    value: true

- name: Show all filename extensions
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleShowAllExtensions
    type: bool
    value: true

- name: Show Finder status bar
  community.general.osx_defaults:
    domain: com.apple.finder
    key: ShowStatusBar
    type: bool
    value: true

- name: Show Finder path bar
  community.general.osx_defaults:
    domain: com.apple.finder
    key: ShowPathbar
    type: bool
    value: true

- name: Keep folders on top when sorting
  community.general.osx_defaults:
    domain: com.apple.finder
    key: _FXSortFoldersFirst
    type: bool
    value: true

- name: Search current folder by default
  community.general.osx_defaults:
    domain: com.apple.finder
    key: FXDefaultSearchScope
    type: string
    value: "SCcf"

- name: Disable file extension change warning
  community.general.osx_defaults:
    domain: com.apple.finder
    key: FXEnableExtensionChangeWarning
    type: bool
    value: false

- name: Avoid .DS_Store on network volumes
  community.general.osx_defaults:
    domain: com.apple.desktopservices
    key: DSDontWriteNetworkStores
    type: bool
    value: true

- name: Avoid .DS_Store on USB volumes
  community.general.osx_defaults:
    domain: com.apple.desktopservices
    key: DSDontWriteUSBStores
    type: bool
    value: true

- name: Use list view in Finder by default
  community.general.osx_defaults:
    domain: com.apple.finder
    key: FXPreferredViewStyle
    type: string
    value: "Nlsv"

- name: Show ~/Library folder
  ansible.builtin.shell: chflags nohidden ~/Library
  changed_when: true

- name: Show /Volumes folder
  ansible.builtin.shell: chflags nohidden /Volumes
  become: true
  changed_when: true

# ═══ Dock ════════════════════════════════════════════════

- name: Set Dock icon size
  community.general.osx_defaults:
    domain: com.apple.dock
    key: tilesize
    type: float
    value: "{{ dock_tilesize }}"

- name: Enable Dock magnification
  community.general.osx_defaults:
    domain: com.apple.dock
    key: magnification
    type: bool
    value: "{{ dock_magnification }}"

- name: Set Dock magnification size
  community.general.osx_defaults:
    domain: com.apple.dock
    key: largesize
    type: float
    value: "{{ dock_largesize }}"

- name: Set Dock position to left
  community.general.osx_defaults:
    domain: com.apple.dock
    key: orientation
    type: string
    value: "{{ dock_orientation }}"

- name: Set minimize effect to Genie
  community.general.osx_defaults:
    domain: com.apple.dock
    key: mineffect
    type: string
    value: "{{ dock_mineffect }}"

- name: "Title bar double-click: Zoom"
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleActionOnDoubleClick
    type: string
    value: Maximize

- name: Minimize windows into application icon
  community.general.osx_defaults:
    domain: com.apple.dock
    key: minimize-to-application
    type: bool
    value: "{{ dock_minimize_to_application }}"

- name: Disable Dock auto-rearrange Spaces
  community.general.osx_defaults:
    domain: com.apple.dock
    key: mru-spaces
    type: bool
    value: false

- name: Set Dock auto-hide delay
  community.general.osx_defaults:
    domain: com.apple.dock
    key: autohide-delay
    type: float
    value: "{{ dock_autohide_delay }}"

- name: Set Dock hide/show animation speed
  community.general.osx_defaults:
    domain: com.apple.dock
    key: autohide-time-modifier
    type: float
    value: "{{ dock_autohide_time_modifier }}"

- name: Enable Dock auto-hide
  community.general.osx_defaults:
    domain: com.apple.dock
    key: autohide
    type: bool
    value: "{{ dock_autohide }}"

- name: Animate opening applications
  community.general.osx_defaults:
    domain: com.apple.dock
    key: launchanim
    type: bool
    value: "{{ dock_launchanim }}"

- name: Show indicators for open applications
  community.general.osx_defaults:
    domain: com.apple.dock
    key: show-process-indicators
    type: bool
    value: "{{ dock_show_process_indicators }}"

- name: Hide recent applications in Dock
  community.general.osx_defaults:
    domain: com.apple.dock
    key: show-recents
    type: bool
    value: "{{ dock_show_recents }}"

# ═══ Desktop Icons ═════════════════════════════════════════

- name: "Desktop: use stacks grouped by Kind"
  ansible.builtin.shell: |
    defaults write com.apple.finder DesktopViewSettings -dict-add GroupBy -string Kind
  changed_when: true

# ═══ Wallpaper ═════════════════════════════════════════════
# Note: Macintosh dynamic wallpaper with Yellow color must be set manually
#       via System Settings > Wallpaper (extension-based wallpaper on Tahoe)

- name: "Wallpaper: reminder to set Macintosh Yellow manually"
  ansible.builtin.debug:
    msg: "MANUAL STEP: Set wallpaper to Macintosh (Yellow) via System Settings > Wallpaper"

# ═══ Desktop & Stage Manager ═══════════════════════════════

- name: Disable Stage Manager
  community.general.osx_defaults:
    domain: com.apple.WindowManager
    key: GloballyEnabled
    type: bool
    value: false

- name: Disable tiled window margins
  community.general.osx_defaults:
    domain: com.apple.WindowManager
    key: EnableTiledWindowMargins
    type: bool
    value: false

- name: Disable iPhone Widgets
  ansible.builtin.shell: defaults write com.apple.chronod remoteWidgetsEnabled -bool false
  changed_when: true

# ═══ Window Management ═════════════════════════════════════

- name: Close windows when quitting application
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSQuitAlwaysKeepsWindows
    type: bool
    value: false

# ═══ Menu Bar ══════════════════════════════════════════════

- name: "Menu bar: auto-hide in full screen only"
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleMenuBarVisibleInFullscreenOnly
    type: bool
    value: true

# ═══ Siri ══════════════════════════════════════════════════

- name: Disable Siri
  community.general.osx_defaults:
    domain: com.apple.assistant.support
    key: "Assistant Enabled"
    type: bool
    value: false

# ═══ Accessibility ═════════════════════════════════════════

- name: "Zoom: enable scroll gesture with modifier"
  community.general.osx_defaults:
    domain: com.apple.universalaccess
    key: closeViewScrollWheelToggle
    type: bool
    value: true

- name: "Zoom: enable trackpad gesture"
  community.general.osx_defaults:
    domain: com.apple.universalaccess
    key: closeViewTrackpadGestureZoomEnabled
    type: bool
    value: true

# ═══ Display ═══════════════════════════════════════════════

- name: Set display resolution to 1680x1050 (scaled)
  ansible.builtin.shell: |
    if command -v displayplacer >/dev/null 2>&1; then
      DISPLAY_ID=$(displayplacer list 2>/dev/null | grep -m1 "Persistent screen id:" | awk '{print $NF}')
      if [ -n "$DISPLAY_ID" ]; then
        displayplacer "id:${DISPLAY_ID} res:1680x1050 scaling:on"
      fi
    fi
  changed_when: true
  failed_when: false

# ═══ Login Items ═══════════════════════════════════════════

- name: Add login items
  ansible.builtin.shell: |
    osascript -e 'tell application "System Events" to make login item at end with properties {path:"{{ item }}", hidden:false}' 2>/dev/null || true
  loop: "{{ login_items }}"
  when: item is exists
  changed_when: true

# ═══ Safari & WebKit ═════════════════════════════════════

- name: "Safari: configure preferences"
  ansible.builtin.shell: |
    SAFARI_PLIST="$HOME/Library/Containers/com.apple.Safari/Data/Library/Preferences/com.apple.Safari.plist"
    if [ -f "$SAFARI_PLIST" ]; then
      defaults write "$SAFARI_PLIST" UniversalSearchEnabled -bool false
      defaults write "$SAFARI_PLIST" SuppressSearchSuggestions -bool true
      defaults write "$SAFARI_PLIST" ShowFullURLInSmartSearchField -bool true
      defaults write "$SAFARI_PLIST" IncludeDevelopMenu -bool true
      defaults write "$SAFARI_PLIST" WebKitDeveloperExtrasEnabledPreferenceKey -bool true
    else
      echo "Safari plist not found (Safari may not have been opened yet)"
    fi
  changed_when: true
  failed_when: false

# ═══ Terminal ════════════════════════════════════════════

- name: Use UTF-8 only in Terminal.app
  community.general.osx_defaults:
    domain: com.apple.terminal
    key: StringEncodings
    type: array
    value:
      - 4

# ═══ Time Machine ════════════════════════════════════════

- name: Disable Time Machine new disk prompts
  community.general.osx_defaults:
    domain: com.apple.TimeMachine
    key: DoNotOfferNewDisksForBackup
    type: bool
    value: true

# ═══ Activity Monitor ════════════════════════════════════

- name: Show main window on launch
  community.general.osx_defaults:
    domain: com.apple.ActivityMonitor
    key: OpenMainWindow
    type: bool
    value: true

- name: Show CPU usage in Dock icon
  community.general.osx_defaults:
    domain: com.apple.ActivityMonitor
    key: IconType
    type: int
    value: 5

- name: Show all processes
  community.general.osx_defaults:
    domain: com.apple.ActivityMonitor
    key: ShowCategory
    type: int
    value: 0

# ═══ TextEdit ════════════════════════════════════════════

- name: Use plain text mode by default
  community.general.osx_defaults:
    domain: com.apple.TextEdit
    key: RichText
    type: int
    value: 0

- name: Open files as UTF-8
  community.general.osx_defaults:
    domain: com.apple.TextEdit
    key: PlainTextEncoding
    type: int
    value: 4

- name: Save files as UTF-8
  community.general.osx_defaults:
    domain: com.apple.TextEdit
    key: PlainTextEncodingForWrite
    type: int
    value: 4

# ═══ Screenshots ═════════════════════════════════════════

- name: Save screenshots to Desktop
  community.general.osx_defaults:
    domain: com.apple.screencapture
    key: location
    type: string
    value: "{{ ansible_facts['env'].HOME }}/Desktop"

- name: Save screenshots as PNG
  community.general.osx_defaults:
    domain: com.apple.screencapture
    key: type
    type: string
    value: "png"

- name: Disable screenshot shadow
  community.general.osx_defaults:
    domain: com.apple.screencapture
    key: disable-shadow
    type: bool
    value: true

# ═══ Hot Corners ═════════════════════════════════════════

- name: "Hot corner: top-left"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-tl-corner
    type: int
    value: "{{ hot_corner_top_left }}"

- name: "Hot corner: top-left modifier"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-tl-modifier
    type: int
    value: 0

- name: "Hot corner: top-right"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-tr-corner
    type: int
    value: "{{ hot_corner_top_right }}"

- name: "Hot corner: top-right modifier"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-tr-modifier
    type: int
    value: 0

- name: "Hot corner: bottom-left"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-bl-corner
    type: int
    value: "{{ hot_corner_bottom_left }}"

- name: "Hot corner: bottom-left modifier"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-bl-modifier
    type: int
    value: 0

- name: "Hot corner: bottom-right"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-br-corner
    type: int
    value: "{{ hot_corner_bottom_right }}"

- name: "Hot corner: bottom-right modifier"
  community.general.osx_defaults:
    domain: com.apple.dock
    key: wvous-br-modifier
    type: int
    value: 0

# ═══ Lock Screen ═══════════════════════════════════════════

- name: Require password immediately after sleep/screensaver
  community.general.osx_defaults:
    domain: com.apple.screensaver
    key: askForPassword
    type: int
    value: 1

- name: No delay for password requirement
  community.general.osx_defaults:
    domain: com.apple.screensaver
    key: askForPasswordDelay
    type: int
    value: 0

# ═══ Energy & Display ════════════════════════════════════

- name: "Battery: display sleep after {{ energy_battery_display_sleep }} min"
  ansible.builtin.shell: "pmset -b displaysleep {{ energy_battery_display_sleep }}"
  become: true
  changed_when: true

- name: "Charger: display sleep after {{ energy_charger_display_sleep }} min"
  ansible.builtin.shell: "pmset -c displaysleep {{ energy_charger_display_sleep }}"
  become: true
  changed_when: true

- name: "Charger: system sleep {{ 'disabled' if energy_charger_system_sleep == 0 else (energy_charger_system_sleep | string + ' min') }}"
  ansible.builtin.shell: "pmset -c sleep {{ energy_charger_system_sleep }}"
  become: true
  changed_when: true

# ═══ Hostname ════════════════════════════════════════════

- name: Set ComputerName
  ansible.builtin.shell: "scutil --set ComputerName '{{ hostname }}'"
  become: true
  changed_when: true

- name: Set HostName
  ansible.builtin.shell: "scutil --set HostName '{{ hostname }}'"
  become: true
  changed_when: true

- name: Set LocalHostName
  ansible.builtin.shell: "scutil --set LocalHostName '{{ hostname }}'"
  become: true
  changed_when: true

- name: Set NetBIOS name
  community.general.osx_defaults:
    domain: /Library/Preferences/SystemConfiguration/com.apple.smb.server
    key: NetBIOSName
    type: string
    value: "{{ hostname }}"
  become: true

# ═══ Restart Affected Applications ═══════════════════════

- name: Restart Dock, Finder, and SystemUIServer
  ansible.builtin.shell: |
    killall Dock 2>/dev/null || true
    killall Finder 2>/dev/null || true
    killall SystemUIServer 2>/dev/null || true
  changed_when: true
