---
# ─── SSH Key Restoration ─────────────────────────────────
#
# Restores SSH keys from the encrypted iCloud backup created
# by scripts/backup.sh. Prompts for the zip password, then
# optionally adds a passphrase and stores it in macOS Keychain
# for Touch ID integration.

- name: Check if SSH key already exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['env'].HOME }}/.ssh/id_ed25519"
  register: ssh_key

- name: Find SSH key backup in iCloud
  ansible.builtin.find:
    paths: "{{ ansible_facts['env'].HOME }}/Library/Mobile Documents/com~apple~CloudDocs"
    patterns: "ssh-keys-encrypted.zip"
    recurse: true
    depth: 3
  register: ssh_backup
  when: not ssh_key.stat.exists

- name: Display backup location
  ansible.builtin.debug:
    msg: "Found SSH backup: {{ ssh_backup.files[0].path }}"
  when:
    - not ssh_key.stat.exists
    - ssh_backup.files | length > 0

- name: Prompt for SSH key zip password
  ansible.builtin.pause:
    prompt: "Enter password for ssh-keys-encrypted.zip"
    echo: false
  register: zip_password
  when:
    - not ssh_key.stat.exists
    - ssh_backup.files | length > 0

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env'].HOME }}/.ssh"
    state: directory
    mode: "0700"
  when:
    - not ssh_key.stat.exists
    - ssh_backup.files | length > 0

- name: Extract SSH keys from encrypted backup
  ansible.builtin.shell: |
    unzip -o -P "{{ zip_password.user_input }}" "{{ ssh_backup.files[0].path }}" -d "{{ ansible_facts['env'].HOME }}/.ssh/"
  no_log: true
  register: unzip_result
  when:
    - not ssh_key.stat.exists
    - ssh_backup.files | length > 0
    - zip_password.user_input | length > 0

- name: Verify SSH key was extracted
  ansible.builtin.stat:
    path: "{{ ansible_facts['env'].HOME }}/.ssh/id_ed25519"
  register: ssh_key_extracted
  when:
    - not ssh_key.stat.exists
    - ssh_backup.files | length > 0
    - zip_password.user_input | length > 0

- name: Fail if SSH key extraction failed
  ansible.builtin.fail:
    msg: "SSH key extraction failed — wrong password or corrupted zip. Re-run with --tags ssh to try again."
  when:
    - not ssh_key.stat.exists
    - ssh_backup.files | length > 0
    - zip_password.user_input | length > 0
    - not ssh_key_extracted.stat.exists

- name: Set SSH private key permissions
  ansible.builtin.file:
    path: "{{ ansible_facts['env'].HOME }}/.ssh/id_ed25519"
    mode: "0600"
  when:
    - not ssh_key.stat.exists
    - ssh_backup.files | length > 0
    - zip_password.user_input | length > 0

- name: Set SSH public key permissions
  ansible.builtin.file:
    path: "{{ ansible_facts['env'].HOME }}/.ssh/id_ed25519.pub"
    mode: "0644"
  when:
    - not ssh_key.stat.exists
    - ssh_backup.files | length > 0
    - zip_password.user_input | length > 0

- name: Set known_hosts permissions
  ansible.builtin.file:
    path: "{{ ansible_facts['env'].HOME }}/.ssh/known_hosts"
    mode: "0644"
  failed_when: false
  when:
    - not ssh_key.stat.exists
    - ssh_backup.files | length > 0
    - zip_password.user_input | length > 0

- name: Check if SSH key has a passphrase
  ansible.builtin.shell: |
    ssh-keygen -y -P "" -f "{{ ansible_facts['env'].HOME }}/.ssh/id_ed25519" > /dev/null 2>&1
  register: key_no_passphrase
  failed_when: false
  changed_when: false
  no_log: true
  when:
    - not ssh_key.stat.exists
    - ssh_backup.files | length > 0
    - zip_password.user_input | length > 0

- name: Prompt for SSH key passphrase
  ansible.builtin.pause:
    prompt: "Enter the passphrase for your SSH key (will be stored in macOS Keychain for Touch ID)"
    echo: false
  register: ssh_passphrase
  when:
    - not ssh_key.stat.exists
    - ssh_backup.files | length > 0
    - zip_password.user_input | length > 0
    - key_no_passphrase.rc != 0

- name: Add SSH key to macOS Keychain (with passphrase)
  ansible.builtin.shell: |
    /usr/bin/expect -c '
      spawn ssh-add --apple-use-keychain {{ ansible_facts["env"].HOME }}/.ssh/id_ed25519
      expect "Enter passphrase"
      send "{{ ssh_passphrase.user_input }}\r"
      expect eof
    '
  no_log: true
  when:
    - not ssh_key.stat.exists
    - ssh_backup.files | length > 0
    - zip_password.user_input | length > 0
    - key_no_passphrase.rc != 0
    - ssh_passphrase.user_input | length > 0

- name: Add SSH key to macOS Keychain (no passphrase)
  ansible.builtin.shell: |
    ssh-add --apple-use-keychain "{{ ansible_facts['env'].HOME }}/.ssh/id_ed25519"
  when:
    - not ssh_key.stat.exists
    - ssh_backup.files | length > 0
    - zip_password.user_input | length > 0
    - key_no_passphrase.rc == 0

- name: Test GitHub SSH connection
  ansible.builtin.shell: ssh -T git@github.com 2>&1 || true
  register: github_ssh
  changed_when: false

- name: Display SSH status
  ansible.builtin.debug:
    msg: "{{ 'GitHub SSH: OK' if 'successfully authenticated' in github_ssh.stdout else 'GitHub SSH: ' + github_ssh.stdout }}"

- name: Skip notice (key already exists)
  ansible.builtin.debug:
    msg: "SSH key already exists at ~/.ssh/id_ed25519 — skipping restoration"
  when: ssh_key.stat.exists

# ─── GitHub CLI Authentication ────────────────────────────

- name: Check if gh CLI is authenticated
  ansible.builtin.shell: gh auth status 2>&1
  register: gh_auth
  changed_when: false
  failed_when: false

- name: Authenticate gh CLI with GitHub
  ansible.builtin.shell: |
    gh auth login --hostname github.com --git-protocol ssh --web
  when: gh_auth.rc != 0

- name: Set git remote to SSH protocol
  ansible.builtin.shell: |
    gh auth setup-git
  when: gh_auth.rc != 0
  changed_when: true

- name: Verify gh auth
  ansible.builtin.shell: gh auth status 2>&1
  register: gh_verify
  changed_when: false
  failed_when: false

- name: Display gh auth status
  ansible.builtin.debug:
    msg: "{{ gh_verify.stdout_lines[0] | default('GitHub CLI: authenticated') }}"
  when: gh_verify.rc == 0
